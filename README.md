#Автотесты для модуля транзита 
АВТОТЕСТЫ на модуль транзита [УМ-40 SMART](https://osr-dev-git.allmonitoring.local/uspd-linux/sw/transit) 

###Что тут есть :
- Тест транзита COM TCP

- Тест транзита TCP COM

- Тест транзита — отваливание линии по таймауту **- НЕ ДОПИСАННО ДО КОНЦА**


##Зависимости 
Все зависимости прописаны в файле `requirements.txt`
- Pyserial - для работы с COM портами
- Request - нужен для настроек сервера транзита \ UART Портов
- Pytest - для запуска тестовых прогонов

## Настройки

За парсинг настроек отвечает файл `ConfigParser.py` 
в Директории `\Service`

Все настройки прописываются в файле `config.ini`

###Значения настроек:
 - `uspd_ip` - IP адрес УСПД 

- `rtu327` - Порт для РТУ327 (Не используется)
- `iface1` - Порт сервера транзита для COM1 (значение по умолчанию - 1111) 
- `iface2` - Порт сервера транзита для COM2 (значение по умолчанию - 2222)
- `iface3` - Порт сервера транзита для COM3 (значение по умолчанию - 3333)
- `iface4` - Порт сервера транзита для COM4 (значение по умолчанию - 4444)


- `COM1` - Имя COM порта на компьютере, который соединен с COM1 на УСПД
- `COM2` - Имя COM порта на компьютере, который соединен с COM2 на УСПД
- `COM3` - Имя COM порта на компьютере, который соединен с COM3 на УСПД
- `COM4` - Имя COM порта на компьютере, который соединен с COM4 на УСПД

- `baudrate` - Скорость COM порта (Значение используется для всех COM портов)

##ТЕСТЫ:
Все тесты направлены на тестирование модуля транзита по схеме:
- -> Отправляем какие-то данные (разрешенные типы данных: str, byte).
   - UPD : теперь происходит автоматический перевод в тип данных.
- <- Нас соответствующем порту получаем эти данные.
-  Если данные равны — то тест успешно пройден
- Assert идет при неравенстве полученных данных
-----------
- В начале работы теста Request-запросами подымаются все необходимые сервера по настройкам указанным в `config.ini`
:TO DO:
- Доделать такой же принцип работы для настроек COM портов

- Тесты написаны только под УМ-40 SMART, однако могут примениться и на УМ-31 SMART   
-----------
###PyTest

- Тестовые прогоны с помощью pytest лежат в файле test_transit.py
    - параметры данных спускаются в массиве словарей parametrize_TCPtoCOM
    - В словарях: 
      - Поле data отвечает за данные которые будут переданы транзитом 
      - Поле COM указывает COM порт через который будет вестись транзит (Имена используются ТОЛЬКО в промежутке COM1-COM4)
    

###Запуск в ручную
Так же в корневой директории содержаться классы для проведения тестовых прогонов учитывая различные сценарии
####Транзит c COM порта на TCP порт
- `COMtoTCP` - тест транзита c определенного COM порта на TCP порт 
    - Класс `COMtoTCP` который лежит в файле `Transit_COM_to_TCP.py`.
  Запускается методом `Setup()` этого же класса. 
  - Принцип работы:
    Запись данных в объявленный COM порт и одновременная прослушка соответствующему ему TCP порта, 
    после выполняется валидация целостности данных.
    COM порт объявляется в методе `Setup()`. 
  - Пример:
    
    ```python
        COMtoTCP('test_test').Setup(COM='COM2')
    ```
- `AllCOMtoTCP` - тест транзита c определенного COM порта на TCP порт - Слушаются все порты TCP 
    - Класс `AllCOMtoTCP` который лежит в файле `Transit_All_Ports_COM_to_TCP.py`.
  Запускается методом `Setup()` этого же класса. 
  - Принцип работы:
    Запись данных в объявленный COM порт и одновременная прослушка всех TCP портов, 
    после выполняется валидация целостности данных ТОЛЬКО на необходимом порту если это не улетело на другой порт.
    COM порт объявляется в методе `Setup()`. 
  - Пример:
    
    ```python
        AllCOMtoTCP('test_test').Setup(COM='COM2')
    ```
####Транзит c TCP порта на COM порт


- `TCPtoCOM` - тест транзита c определенного TCP порта на COM порт 
    - Класс `TCPtoCOM` который лежит в файле `Transit_TCP_to_COM.py`.
  Запускается методом `Setup()` этого же класса. 
  - Принцип работы:
    Запись данных в объявленный TCP порт и одновременная прослушка соответствующему ему COM порта, 
    после выполняется валидация целостности данных.
    COM порт объявляется в методе `Setup()`. 
  - Пример:
    
    ```python
        TCPtoCOM('test_test').Setup(COM='COM2')
    ```
- `AllTCPtoCOM` - тест транзита c определенного TCP порта на COM порт - Слушаются все порты COM 
    - Класс `AllTCPtoCOM` который лежит в файле `Transit_All_Ports_TCP_to_COM.py`.
  Запускается методом `Setup()` этого же класса. 
  - Принцип работы:
    Запись данных в объявленный TCP порт и одновременная прослушка всех COM портов, 
    после выполняется валидация целостности данных ТОЛЬКО на необходимом порту если это не улетело на другой порт.
    COM порт объявляется в методе `Setup()`. 
  - Пример:
    
    ```python
        AllTCPtoCOM('test_test').Setup(COM='COM2')
    ```

#### Имитация обмена TCP-COM

В качестве полного теста транзита и возможности эмуляции обмена со счетчиком командами используется тесты эмуляции обмена        
:open_mouth: Возможно сюда потом прилепить более осмысленные команды

- `TransitMessaging` - тест транзита c обменом командами
    - Класс `TransitMessaging` который лежит в файле `Transit_messaging.py`.
  Запускается методом `Setup()` этого же класса. 
  - Принцип работы:
    В классе осуществляется запуск классов СНАЧАЛА `TCPtoCOM`, а после `COMtoTCP` необходимое количество раз используя необходимые сообщения
    При Этом слушается только заданный COM порт и соответствующий ему TCP порт
  - COM порт и Количество циклов обмена объявляется в методе `Setup()`.
    Шаблон сообщений задается в конструкторе класса
  - Пример:
    
    ```python
    TransitMessaging(
                                    message_from_meter='message_from_meter', 
                                    message_to_meter='message_to_meter'
                        
                        ).Setup(COM="COM1", count_messages=10)
    ```
- `TransitMessagingAllPorts` - тест транзита c определенного TCP порта на COM порт - Слушаются все порты COM 
    - Класс `COMtoTCP` который лежит в файле `Transit_All_Ports_Messaging.py`.
  Запускается методом `Setup()` этого же класса. 
  - Принцип работы:
    В классе осуществляется запуск классов СНАЧАЛА `AllTCPtoCOM`, а после `AllCOMtoTCP` необходимое количество раз используя необходимые сообщения
    При Этом слушается все порты на выходе
  - COM порт и Количество циклов обмена объявляется в методе `Setup()`.
    Шаблон сообщений задается в конструкторе класса
    
  - Пример:
    
    ```python
    TransitMessagingAllPorts(
                                    message_from_meter='message_from_meter', 
                                    message_to_meter='message_to_meter'
                        
                        ).Setup(COM="COM1", count_messages=10)
    ```


#### Отваливание транзита по тайм-ауту
Класс, который тестирует отваливание сокета по таймауту    

-`TimeoutFallOff`  - тест, который заставляет отвалиться сокет по таймауту.
  - Класс `TimeoutFallOff` который лежит в файле `Transit_Timeout_FallOff.py`. 
  - Принцип работы:
TCP соединение держиться, но данных не поступает 
МЫ свободно можем запустить новый транзит через 120 секунд и COM порт не будет занят
  - Пример:
    ```python
    TimeoutFallOff().Setup()
    ```